<!DOCTYPE html>

<html lang="zh-hant" xmlns:th="http://www.thymeleaf.org">

<head>
    <link th:include="frontstage/index2 :: head">

    <!--    收藏用的彈窗    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        .favorite {
            color: red;
        }
    </style>
</head>

<body id="body" th:data-member-no="${memberNo}" onload="initFavorites()">
<div th:replace="frontstage/index2 :: header"></div>


<!-- 頁面內容 -->
    <section class="events section">
        <div class="events container">
        <div class="row" >
            <div class="col-md-4" th:each="event : ${events}">
                <div class="product-item">
                    <div class="product-thumb">
                        <img class="img-responsive" th:src="'data:image/jpeg;base64, '+${event.getEventImgBase64()}" alt="event-img" />
                        <div class="preview-meta">
                            <ul>
                                <li>
                                    <a th:href="@{'/events/' + ${event.eventNo}}"><i class="tf-ion-ios-search-strong"></i></a>
                                </li>
                                <li>
                                    <a href="#!" th:data-event-no="${event.eventNo}" onclick="toggleFavorite(this, event)"><i class="tf-ion-ios-heart"></i></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="product-content">
                        <p class="date" th:text="${#dates.format(event.eventStartTime, 'yyyy-MM-dd HH:mm')} + ' ~ ' + ${#dates.format(event.eventEndTime, 'yyyy-MM-dd HH:mm')}" ></p>
                        <h4><a th:href="@{'/events/' + ${event.eventNo}}" th:text="${event.eventName}"></a></h4>
                        <div class="event_location">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="#989797" class="bi bi-geo-alt-fill" viewBox="0 0 16 16">
                                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/>
                            </svg><span class="location" th:text="${event.eventCity}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>


<div th:replace="frontstage/index2 :: footer"></div>

<script>
    function initFavorites() {
        const memberNo = document.getElementById('body').getAttribute('data-member-no');
        fetch(`/saveevent/findFavoritesByMember/${memberNo}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(event => {
                    const icon = document.querySelector(`a[data-event-no="${event.eventNo}"] i`);
                    if (icon) {
                        icon.classList.add('favorite');
                        icon.style.color = 'red';
                    }
                });
            })
            .catch(error => {
                console.error('初始化收藏狀態時出錯:', error);
            });
    }

    function toggleFavorite(element, e) {
        e.preventDefault();

        const icon = element.querySelector('i');
        const isFavorite = icon.classList.contains('favorite');
        const eventNoStr = element.getAttribute('data-event-no');
        const eventNo = parseInt(eventNoStr, 10);

        if (isNaN(eventNo)) {
            console.error('活動編號轉換失敗，值為:', eventNoStr);
            return;
        }

        const newStatus = isFavorite ? 0 : 1;
        const memberNo = document.getElementById('body').getAttribute('data-member-no');

        const data = {
            eventNo: eventNo,
            memberNo: parseInt(memberNo, 10)
        };

        fetch('/saveevent/insert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(data).toString()
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (newStatus === 1) {
                        icon.classList.add('favorite');
                        icon.style.color = 'red';
                        Swal.fire({
                            title: '已收藏',
                            text: '你已收藏該活動。',
                            icon: 'success',
                            confirmButtonText: '確定'
                        });
                    } else {
                        icon.classList.remove('favorite');
                        icon.style.color = '';
                        Swal.fire({
                            title: '取消收藏',
                            text: '你已取消收藏該活動。',
                            icon: 'warning',
                            confirmButtonText: '確定'
                        });
                    }
                } else {
                    console.error("收藏操作失敗");
                }
            })
            .catch(error => {
                console.error('錯誤:', error);
            });
    }
</script>

</body>
</html>