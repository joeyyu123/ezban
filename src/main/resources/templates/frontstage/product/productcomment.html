<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評星和評論系統</title>
    <style>
        #star-rating .star {
            font-size: 30px;
            cursor: pointer;
            color: black;
            display: inline-block;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
        }

        #star-rating .star.rated {
            color: #FFD306;
        }

        .average-rating {
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        .average-rating .stars {
            margin-left: 10px;
            color: #FFD306;
        }

        .average-rating .count {
            margin-left: 10px;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin-top: 20px;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            max-width: 500px;
            max-height: 100px;
        }

        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #comments-display {
            margin-top: 20px;
            border-top: 2px solid #ccc;
            padding-top: 10px;
        }

        .comment-item {
            margin-bottom: 20px;
        }

        .comment-header {
            display: flex;
            align-items: center;
        }

        .comment-header .member-id {
            margin-right: 10px;
        }

        .comment-header .comment-rating {
            color: #FFD306;
        }

        .comment-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }

        .comment-content {
            flex-grow: 1;
        }

        .report-button {
            background-color: red;
            color: white;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>產品評分和評論</h1>

    <div id="product-info">
        <div class="average-rating">
            <span id="average-rating-value">0.0</span>
            <div class="stars" id="average-rating-stars"></div>
            <span class="count" id="rating-count">(0)</span>
        </div>
    </div>

    <div id="comments-display">
        <!-- 評論將會顯示在這裡 -->
    </div>

    <div id="star-rating">
        <span class="star" onclick="setRating(1)">&#9733;</span>
        <span class="star" onclick="setRating(2)">&#9733;</span>
        <span class="star" onclick="setRating(3)">&#9733;</span>
        <span class="star" onclick="setRating(4)">&#9733;</span>
        <span class="star" onclick="setRating(5)">&#9733;</span>
    </div>

    <textarea id="commentContent" placeholder="寫下你的評論..."></textarea>
    <button onclick="submitComment()">提交評論</button>

    <script>
        var currentRating = 0;
        var productNo = 1;

        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll('#star-rating .star');
            for (let i = 0; i < stars.length; i++) {
                if (i < rating) {
                    stars[i].classList.add('rated');
                } else {
                    stars[i].classList.remove('rated');
                }
            }
        }

        function getCurrentMemberNo() {
            return "1";
        }

        function submitComment() {
            const commentContent = document.getElementById('commentContent').value;
            if (!currentRating || !commentContent.trim()) {
                alert("請填寫評分和評論內容！");
                return;
            }

            const data = {
                product: { productNo: productNo },
                member: { memberNo: getCurrentMemberNo() },
                productCommentContent: commentContent,
                productRate: currentRating,
                productCommentDate: new Date().toISOString(),
                productCommentStatus: 0
            };

            console.log("提交的評論數據:", data);

            fetch('/api/product/comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(comment => {
                alert("評論已提交！");
                loadComments(productNo);
                loadCommentStats(productNo);
            })
            .catch(error => {
                console.error('提交評論出錯:', error);
                alert('提交評論失敗');
            });
        }

        function loadComments(productNo) {
            fetch(`/api/product/comment/${productNo}`)
            .then(response => response.json())
            .then(comments => {
                console.log(comments);
                if (!Array.isArray(comments)) {
                    throw new TypeError('期望得到評論的數組，但實際得到:', comments);
                }
                const commentsDisplay = document.getElementById('comments-display');
                commentsDisplay.innerHTML = '';
                comments.forEach(comment => {
                    const stars = '★'.repeat(comment.productRate) + '☆'.repeat(5 - comment.productRate);
                    const commentItem = `<div class="comment-item">
                        <div class="comment-header">
                            <span class="member-id">會員編號: ${comment.memberNo}</span>
                            <div class="comment-rating">${stars}</div>
                        </div>
                        <div class="comment-content-wrapper">
                            <div class="comment-content">${comment.commentContent}</div>
                            <button class="report-button" data-comment-id="${comment.productCommentNo}" onclick="reportComment(this)">檢舉</button>
                        </div>
                    </div>`;
                    commentsDisplay.innerHTML += commentItem;
                });
            })
            .catch(error => {
                console.error('加載評論出錯:', error);
            });
        }

        function loadCommentStats(productNo) {
            fetch(`/api/product/comment/stats/${productNo}`)
            .then(response => response.json())
            .then(stats => {
                console.log(stats);
                const averageRatingValue = document.getElementById('average-rating-value');
                const averageRatingStars = document.getElementById('average-rating-stars');
                const ratingCount = document.getElementById('rating-count');

                averageRatingValue.textContent = stats.averageRating.toFixed(1);
                averageRatingStars.innerHTML = '★'.repeat(Math.round(stats.averageRating)) + '☆'.repeat(5 - Math.round(stats.averageRating));
                ratingCount.textContent = `(${stats.ratingCount})`;
            })
            .catch(error => {
                console.error('加載評分統計出錯:', error);
            });
        }

        function reportComment(button) {
            const commentId = button.getAttribute('data-comment-id');
            console.log("檢舉評論ID:", commentId); // 日誌
            const reportReason = prompt("請輸入檢舉理由：");
            if (!reportReason) {
                alert("檢舉理由不能為空！");
                return;
            }

            const data = {
                productCommentNo: parseInt(commentId),
                memberNo: parseInt(getCurrentMemberNo()),
                reportReason: reportReason,
                reportDate: new Date().toISOString(),
                reportStatus: 0
            };

            console.log("提交的檢舉數據:", data); // 日誌

            fetch('/api/product/comment/report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(result => {
                alert("檢舉已提交！");
            })
            .catch(error => {
                console.error('檢舉出錯:', error);
                alert('檢舉失敗');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadComments(productNo);
            loadCommentStats(productNo);
        });
    </script>
</body>
</html>
