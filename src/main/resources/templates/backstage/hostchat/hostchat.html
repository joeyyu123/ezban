<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
    <link th:include="backstage/index :: head">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        #wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: calc(100% - 20px);
            padding: 20px;
            box-sizing: border-box;
        }

        .page-content-wrapper {
            display: flex;
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        #contactList {
            width: 250px;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            background-color: #f4f4f4;
            padding: 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        #contactList h3 {
            margin-top: 0;
        }

        .contact {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .contact:hover {
            background-color: #e9e9e9;
        }

        .contact img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .contact-info {
            flex-grow: 1;
        }

        .contact-info p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        .contact-info .name {
            font-weight: bold;
            color: #333;
        }

        .contact .time {
            font-size: 0.8em;
            color: #999;
        }

        #chatContainer {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        #chatHistory {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #fff;
            word-wrap: break-word;
        }

        #inputArea {
            display: none;
            padding: 10px;
            border-top: 1px solid #ccc;
            background-color: #f4f4f4;
            align-items: center;
        }

        #messageInput {
            flex-grow: 1;
            height: 40px;
            resize: none;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        #sendButton {
            padding: 10px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            height: 40px;
            align-self: center;
        }

        #sendButton:hover {
            background-color: #0056b3;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
            max-width: calc(100% - 270px);
            word-wrap: break-word;
        }

        .mine {
            background-color: #007bff;
            color: white;
            text-align: right;
            float: right;
            clear: both;
        }

        .theirs {
            background-color: #ebebeb;
            text-align: left;
            float: left;
            clear: both;
        }

        .timestamp {
            display: block;
            font-size: 0.7em;
            color: #000;
            font-family: Arial, sans-serif;
            text-align: right;
            margin-top: 2px;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <nav th:replace="backstage/index :: navbar"></nav>
    <div th:insert="backstage/index :: hamburger-btn"></div>
    <div class="page-content-wrapper">
        <input type="hidden" id="memberNo" th:value="${memberNo}">
        <input type="hidden" id="hostName" th:value="${hostName}">
        <input type="hidden" id="eventNo" th:value="${eventNo}">
        <div id="contactList">
            <h3>會員</h3>
            <div id="contactNames"></div>
        </div>
        <div id="chatContainer">
            <div id="chatHistory"></div>
            <div id="inputArea">
                <textarea id="messageInput" placeholder="輸入訊息" onkeypress="handleKeyPress(event)"></textarea>
                <button id="sendButton" onclick="sendMessage()">發送</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    var stompClient = null;
    var connected = false;
    var selectedUser = null;
    var memberNo = /*[[${memberNo}]]*/ '[[${memberNo}]]';
    var memberName = /*[[${memberName}]]*/ '[[${memberName}]]';
    var hostName = /*[[${hostName}]]*/ '[[${hostName}]]';
    var eventNo = /*[[${eventNo}]]*/ '[[${eventNo}]]';

    console.log("hostName: ", hostName);

    $(document).ready(function () {
        connect();
        loadChatHistory();
    });

    function connect() {
        if (stompClient !== null && stompClient.connected) {
            return;
        }
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            connected = true;
            console.log('已連接: ' + frame);
            stompClient.subscribe(`/message/event/${eventNo}`, function (messageOutput) {
                var message = JSON.parse(messageOutput.body);
                displayMessage(message);
            });
            loadContacts();
        }, function (error) {
            console.error('WebSocket 錯誤: ' + error);
            connected = false;
        });
    }

    // 加載使用者列表並顯示每個使用者的最後訊息
    function loadContacts() {
        fetch('/backstage/hostchat/lastMessages')
            .then(response => response.json())
            .then(lastMessages => {
                fetch('/backstage/hostchat/members')
                    .then(response => response.json())
                    .then(contacts => {
                        var contactList = document.getElementById('contactNames');
                        contactList.innerHTML = '';
                        contacts.forEach(contact => {
                            var lastMessage = lastMessages[contact];
                            if (lastMessage && contact !== hostName) {
                                var contactElement = document.createElement('div');
                                contactElement.classList.add('contact');
                                contactElement.onclick = function (event) {
                                    selectedUser = contact;
                                    document.getElementById('chatHistory').innerHTML = '';
                                    document.getElementById('inputArea').style.display = 'flex';
                                    fetchHistory(contact);
                                    event.stopPropagation();
                                };
                                contactElement.innerHTML = `
                                <img src="https://via.placeholder.com/40" alt="${contact}">
                                <div class="contact-info">
                                    <span class="name">${contact}</span>
                                    <p id="lastMessage_${contact}">${truncateMessage(lastMessage.message, 20)}</p>
                                </div>
                                <span class="time" id="lastTime_${contact}">${lastMessage.timestamp ? new Date(lastMessage.timestamp).toLocaleDateString() : ''}</span>
                            `;
                                contactList.appendChild(contactElement);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('獲取使用者錯誤:', error);
                    });
            })
            .catch(error => {
                console.error('獲取最後訊息錯誤:', error);
            });
    }

    // 獲取指定用戶的聊天歷史
    function fetchHistory(memberName) {
        console.log(`Fetching history for ${memberName}`);
        fetch(`/backstage/hostchat/history/${memberName}/${hostName}`)
            .then(response => response.json())
            .then(messages => {
                console.log(`Received messages: ${JSON.stringify(messages)}`);
                var messageList = document.getElementById('chatHistory');
                messageList.innerHTML = '';
                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        displayMessage(message);
                    });
                } else {
                    var noMessagesElement = document.createElement('div');
                    noMessagesElement.innerText = '沒有聊天記錄';
                    messageList.appendChild(noMessagesElement);
                }
            })
            .catch(error => {
                console.error('獲取歷史訊息錯誤:', error);
            });
    }

    // 顯示訊息
    function displayMessage(message) {
        console.log(`Displaying message from ${message.sender} to ${message.receiver}: ${message.message}`);

        var messageList = document.getElementById('chatHistory');
        var msgElement = document.createElement('div');
        msgElement.classList.add('message');
        msgElement.classList.add(message.sender === hostName ? 'mine' : 'theirs');
        msgElement.innerText = message.message;
        var timestampElement = document.createElement('span');
        timestampElement.classList.add('timestamp');
        timestampElement.innerText = new Date(message.timestamp).toLocaleString();
        msgElement.appendChild(timestampElement);
        messageList.appendChild(msgElement);
        messageList.scrollTop = messageList.scrollHeight;

        var lastMessageElement = document.getElementById(`lastMessage_${message.sender}`);
        var lastTimeElement = document.getElementById(`lastTime_${message.sender}`);
        if (lastMessageElement && lastTimeElement) {
            lastMessageElement.innerText = truncateMessage(message.message, 20);
            lastTimeElement.innerText = new Date(message.timestamp).toLocaleDateString();
        }
    }

    // 發送訊息
    function sendMessage() {
        var messageInput = $('#messageInput').val();
        if (messageInput) {
            var messageObj = {
                'type':'host',
                'message': messageInput,
                'sender': hostName,
                'receiver': selectedUser,
                'timestamp': new Date().toISOString()
            };
            stompClient.send(`/hostchat/sendMessage/${eventNo}`, {}, JSON.stringify(messageObj));
            $('#messageInput').val('');
        }
    }

    // 處理鍵盤事件，按下 Enter 鍵時發送訊息
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // 點擊其他地方隱藏輸入框
    document.addEventListener('click', function (event) {
        if (!document.getElementById('contactList').contains(event.target) &&
            !document.getElementById('chatContainer').contains(event.target)) {
            document.getElementById('inputArea').style.display = 'none';
        }
    });

    // 截斷訊息，超過指定字數後顯示...
    function truncateMessage(message, maxLength) {
        return message.length > maxLength ? message.substring(0, maxLength) + '...' : message;
    }

    function loadChatHistory() {
        console.log(`Loading chat history for member ${memberName} and host ${hostName}`);
        $.ajax({
            url: `/backstage/hostchat/history/${memberName}/${hostName}`,
            method: 'GET',
            success: function (chatHistory) {
                console.log('Loaded chat history:', chatHistory);
                chatHistory.forEach(function (message) {
                    console.log(`Displaying message: ${JSON.stringify(message)}`);
                    displayMessage(message);
                });
            },
            error: function (error) {
                console.error('Error loading chat history:', error);
            }
        });
    }
</script>
</body>
</html>